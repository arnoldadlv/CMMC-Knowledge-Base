# 3.13.6 - Expertise Overlay

**Control Text:** Deny network communications traffic by default and allow network communications traffic by exception (i.e., deny all, permit by exception).

**Assessment Objectives:**
- 3.13.6[a] network communications traffic is denied by default.
- 3.13.6[b] network communications traffic is allowed by exception.

---

## Sufficient

### Inbound Traffic
- Deny all inbound by default - widely agreed as straightforward to implement
- Block all inbound ports on Windows Defender Firewall or network firewall

### Outbound Traffic
- Default outbound action set to "block" in firewall policy with allow rules for specific ports
- Port-based filtering is acceptable - filtering by IP is "more than required" (Amira Armond, C3PAO)
- Core functionality ports that should be allowed outbound (confirmed passed L2 assessment):
  - 80 (HTTP)
  - 443 (HTTPS)
  - 53 (DNS)
  - 67, 68 (DHCP)
  - 123 (NTP)
  - ICMP
  - RPC, Kerberos KDC (if in AD environment)
  - SMB (if in AD environment)
- Dynamic/ephemeral ports (49152-65535 for local ports) must remain open for outbound connections to function
- Layered policy approach in Intune: baseline "DO NOT TOUCH" policy for core functionality + standard application ports policy + role-based policies (e.g., IT dept gets SSH)

### Configuration Approach
- Use deny by default at the Firewall general policy level, with allow rules in the firewall ports policy
- Last rule on firewall list should be "DENY ALL" with Allow rules above it
- Windows Defender Firewall rules pushed via Intune Endpoint Security > Firewall > Firewall Rules policies
- Disable local policy merge in Intune to prevent default local firewall rules from being applied

### Mobile Devices
- Phone OSes don't have native capability for this control - one practitioner noted they don't apply this to mobile devices

### macOS
- macOS default firewall uses blacklisting approach, not whitelist/deny-by-default
- Use "packet filter" (pf) on macOS for traditional deny-by-default with port exceptions

---

## Insufficient

### Inverted Logic (Critical Misunderstanding)
- Creating rules that "deny ports 1-52, 54-442, 444-65535" instead of "allow 53, allow 443, deny all"
- This is "Deny by exception, allow by default" - the OPPOSITE of what the control requires
- Even if the same ports are effectively blocked, you are not doing what the literal assessment objectives say
- Risk: If you deny TCP 1-65535 but forget UDP or ICMP, those protocols are allowed because you didn't explicitly deny them

### Outbound Traffic Overlooked
- "This requirement does not say 'deny traffic by default except when it is outgoing'" (Amira Armond, C3PAO)
- Blocking only inbound while allowing all outbound does NOT meet the control

### Using Web Content Filtering Instead
- Blocking file sharing sites, streaming, etc. with Defender content filtering is NOT deny-by-default
- "A block isn't 'deny by default' though, it's the opposite"

### Protocol Gaps
- Denying only TCP ports without addressing UDP leaves UDP traffic allowed by default
- Not blocking ICMP when using exception-based approach

---

## Over-engineering

### IP/Site Whitelisting
- "Whitelisting IPs/Sites is an insane read of the control in my opinion" (John, passed L2)
- Port-based filtering is sufficient; IP filtering is more than required

### Per-Application Firewall Rules
- "Doing per .exe rules would kill me" - port-based rules are acceptable
- Open 443 outbound for all applications rather than per-application rules

---

## Edge Cases

### Ephemeral/Dynamic Ports
- Local outbound ports 49152-65535 (IANA official range) must remain open for internet connections
- Some services use ports outside 49152-65535 as ephemeral - one practitioner found they needed to allow 1-65535 for local outbound ports after device lost internet access after 24 hours
- Difference between "local ports" and "remote ports" in firewall rules is critical

### Intune Policy Conflicts
- If you set "Allow Local Policy Merge" to False but create rules elsewhere, the device loses all connectivity
- Windows Firewall GUI does NOT reflect rules pushed via MDM or GPO - must use PowerShell with `-policystore MDM` flag to query rules

### Windows Default Firewall Rules
- Disabling merging local rules can break Windows UWP apps that rely on auto-generated rules
- One practitioner confirmed disabling all default rules "is working so far"

### Testing Strategy
- Enable deny-all for public OR private network profile only during testing
- If internet breaks, switch to the other network zone to recover

---

## Evidence Examples

### Passed L2 Assessment (Confirmed)
- Windows Firewall via Intune with:
  - Deny all outbound by default in Firewall policy
  - Firewall Rules policies allowing specific ports (80, 443, 53, 67, 68, 123, ICMP)
  - Layered policies: baseline + standard apps + role-based
- Inbound blocked
- Assessor asked: "Did you pass an L2 assessment with this Windows Firewall configuration?" Answer: "Yes sir."

### Implementation Evidence to Show
- Firewall policy showing default outbound action = block
- Firewall rules showing specific allow exceptions
- Screenshot/export of Intune Endpoint Security > Firewall configuration
- PowerShell output: `Get-NetFirewallRule -PolicyStore MDM` (rules pushed via Intune don't show in GUI)

---

## Key Quotes

> "This requirement does not say 'deny traffic by default except when it is outgoing'" - Amira Armond (C3PAO)

> "If your outbound has deny all as the last rule, you should be good. It is totally ok to filter by port as your main tactic. Filtering by IP is more than required." - Amira Armond (C3PAO)

> "You are not doing what the literal assessment objectives say. You are doing the opposite of what they say. Denys by exception, allow by default" - Amira Armond (C3PAO) on inverted deny-rule approach

> "It kinda is [semantics], but if you don't block traffic by default, then you get into situations where your ruleset denys TCP 1-65555 but you didn't block UDP and now all UDP is allowed because you didn't explicitly deny it. And you may not be blocking ICMP by default either" - Amira Armond (C3PAO)

> "I use deny by default at the Firewall general policy, and have allow rules in the firewall ports policy, they work together very well." - Amira Armond (C3PAO)

> "Whitelisting IPs/Sites is an insane read of the control in my opinion." - John (passed L2 assessment)

> "We do NOT open 443 inbound (and neither should you on anything that's not a web server), but we opened 443 outbound for all applications. Doing per .exe rules would kill me." - John (passed L2 assessment)

> "outgoing is hard and the part often missed. I dont have a good list. I think it is very system specific." - Spock67 (Certified CMMC Assessor)

> "If you are creating them anywhere else, but have the 'Allow Local Policy Merge' set to False in your firewall policy, you're going to have a bad time" - John (passed L2 assessment)

> "the problem with the macOS default firewall was there is no way to configure a 'deny by default' configuration. it was more of a blacklisting approach" - anon305 (CCP)

---

## Resources Shared

- Microsoft port requirements documentation: https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/service-overview-and-network-port-requirements

---

*Source: Cooey COE Discord - 3.13.6 channel export (84 messages, 2022-09-16 to 2025-12-03)*
